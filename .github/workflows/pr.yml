name: PR

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Install FPC
        run: sudo apt-get update && sudo apt-get install fpc -qq > /dev/null

      - name: Build all
        run: ./build.pas --prod

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-pr
          retention-days: 1
          path: |
            build/ScriptLoader
            build/TestRunner
            build/BenchmarkRunner
            build/REPL

  test:
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-pr
          path: build/

      - name: Make binaries executable
        run: chmod +x build/*

      - name: Run all JavaScript tests
        run: ./build/TestRunner tests

  benchmark:
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-pr
          path: build/

      - name: Make binaries executable
        run: chmod +x build/*

      - name: Restore benchmark baseline
        id: baseline
        uses: actions/cache/restore@v4
        with:
          path: benchmark-results.json
          key: benchmark-baseline-will-not-match
          restore-keys: benchmark-baseline-

      - name: Prepare baseline
        run: |
          if [ -f benchmark-results.json ]; then
            mv benchmark-results.json benchmark-baseline.json
            echo "BASELINE_EXISTS=true" >> "$GITHUB_ENV"
          else
            echo "BASELINE_EXISTS=false" >> "$GITHUB_ENV"
          fi

      - name: Run benchmarks
        run: ./build/BenchmarkRunner benchmarks --format=json --output=benchmark-results.json

      - name: Compare benchmarks and comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const current = JSON.parse(fs.readFileSync('benchmark-results.json', 'utf8'));

            let baseline = null;
            if (process.env.BASELINE_EXISTS === 'true') {
              try {
                baseline = JSON.parse(fs.readFileSync('benchmark-baseline.json', 'utf8'));
              } catch (e) {
                console.log('Failed to parse baseline:', e.message);
              }
            }

            const flatten = (data) => {
              const map = {};
              for (const file of data.files) {
                for (const bench of file.benchmarks) {
                  if (!bench.error) {
                    map[`${bench.suite} > ${bench.name}`] = bench.opsPerSec;
                  }
                }
              }
              return map;
            };

            const fmtOps = (n) => {
              return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };

            const currentMap = flatten(current);

            let body = '## Benchmark Results\n\n';

            if (baseline) {
              const baselineMap = flatten(baseline);

              body += '| Benchmark | Base (ops/sec) | PR (ops/sec) | Change |\n';
              body += '|-----------|---------------|-------------|--------|\n';

              const names = Object.keys(currentMap).sort();
              for (const name of names) {
                const ops = currentMap[name];
                const baseOps = baselineMap[name];

                if (baseOps && baseOps > 0) {
                  const change = ((ops - baseOps) / baseOps) * 100;
                  let indicator;
                  if (change > 2) {
                    indicator = `ðŸŸ¢ +${change.toFixed(1)}%`;
                  } else if (change < -2) {
                    indicator = `ðŸ”´ ${change.toFixed(1)}%`;
                  } else {
                    indicator = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
                  }
                  body += `| ${name} | ${fmtOps(baseOps)} | ${fmtOps(ops)} | ${indicator} |\n`;
                } else {
                  body += `| ${name} | â€” | ${fmtOps(ops)} | ðŸ†• new |\n`;
                }
              }
            } else {
              body += '> No baseline benchmark data found for `main`. Comparison skipped.\n\n';
              body += '| Benchmark | ops/sec |\n';
              body += '|-----------|--------|\n';
              const names = Object.keys(currentMap).sort();
              for (const name of names) {
                body += `| ${name} | ${fmtOps(currentMap[name])} |\n`;
              }
            }

            body += `\n<sub>Measured on ubuntu-latest x64. Results may vary by Â±2-3% due to CI environment noise.</sub>`;

            const marker = '<!-- benchmark-comparison -->';
            body = marker + '\n' + body;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
