name: PR

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install FPC
        run: sudo apt-get update && sudo apt-get install fpc -qq > /dev/null

      - name: Check formatting
        run: ./format.pas --check

      - name: Build all
        run: ./build.pas --prod

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-pr
          retention-days: 1
          path: |
            build/ScriptLoader
            build/TestRunner
            build/BenchmarkRunner
            build/REPL

  test:
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-pr
          path: build/

      - name: Make binaries executable
        run: chmod +x build/*

      - name: Run all JavaScript tests
        run: ./build/TestRunner tests

  benchmark:
    needs: build
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build
        uses: actions/download-artifact@v4
        with:
          name: build-pr
          path: build/

      - name: Make binaries executable
        run: chmod +x build/*

      - name: Restore benchmark baseline
        id: baseline
        uses: actions/cache/restore@v4
        with:
          path: benchmark-results.json
          key: benchmark-baseline-will-not-match
          restore-keys: benchmark-baseline-

      - name: Prepare baseline
        run: |
          if [ -f benchmark-results.json ]; then
            mv benchmark-results.json benchmark-baseline.json
            echo "BASELINE_EXISTS=true" >> "$GITHUB_ENV"
          else
            echo "BASELINE_EXISTS=false" >> "$GITHUB_ENV"
          fi

      - name: Run benchmarks
        run: ./build/BenchmarkRunner benchmarks --no-progress --format=json --output=benchmark-results.json

      - name: Compare benchmarks and comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const THRESHOLD = 7; // % change considered significant

            const current = JSON.parse(fs.readFileSync('benchmark-results.json', 'utf8'));

            let baseline = null;
            if (process.env.BASELINE_EXISTS === 'true') {
              try {
                baseline = JSON.parse(fs.readFileSync('benchmark-baseline.json', 'utf8'));
              } catch (e) {
                console.log('Failed to parse baseline:', e.message);
              }
            }

            const fmtOps = (n) => Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            const baselineByFile = {};
            if (baseline) {
              for (const file of baseline.files) {
                const map = {};
                for (const bench of file.benchmarks) {
                  if (!bench.error) map[`${bench.suite} > ${bench.name}`] = bench.opsPerSec;
                }
                baselineByFile[file.file] = map;
              }
            }

            const fmtAvg = (changes) => {
              if (changes.length === 0) return '';
              const avg = changes.reduce((a, b) => a + b, 0) / changes.length;
              const sign = avg >= 0 ? '+' : '';
              return ` Â· avg ${sign}${avg.toFixed(1)}%`;
            };

            let body = '## Benchmark Results\n\n';
            let totalBenchmarks = 0;
            let totalImproved = 0;
            let totalRegressed = 0;
            let totalNew = 0;
            let totalUnchanged = 0;
            const allChanges = [];

            const fileBlocks = [];

            for (const file of current.files) {
              const fileName = file.file;
              const baseMap = baselineByFile[fileName] || {};
              const hasBaseline = baseline && Object.keys(baseMap).length > 0;

              let fileImproved = 0;
              let fileRegressed = 0;
              let fileNew = 0;
              let fileUnchanged = 0;
              let fileRows = '';
              const fileChanges = [];

              const benches = file.benchmarks.filter(b => !b.error);
              totalBenchmarks += benches.length;

              if (hasBaseline) {
                fileRows += '| Benchmark | Base (ops/sec) | PR (ops/sec) | Change |\n';
                fileRows += '|-----------|---------------|-------------|--------|\n';

                for (const bench of benches) {
                  const key = `${bench.suite} > ${bench.name}`;
                  const ops = bench.opsPerSec;
                  const baseOps = baseMap[key];

                  if (baseOps && baseOps > 0) {
                    const change = ((ops - baseOps) / baseOps) * 100;
                    fileChanges.push(change);
                    allChanges.push(change);
                    let indicator;
                    if (change > THRESHOLD) {
                      indicator = `ðŸŸ¢ +${change.toFixed(1)}%`;
                      fileImproved++;
                    } else if (change < -THRESHOLD) {
                      indicator = `ðŸ”´ ${change.toFixed(1)}%`;
                      fileRegressed++;
                    } else {
                      indicator = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
                      fileUnchanged++;
                    }
                    fileRows += `| ${bench.name} | ${fmtOps(baseOps)} | ${fmtOps(ops)} | ${indicator} |\n`;
                  } else {
                    fileRows += `| ${bench.name} | â€” | ${fmtOps(ops)} | ðŸ†• new |\n`;
                    fileNew++;
                  }
                }
              } else {
                fileRows += '| Benchmark | ops/sec |\n';
                fileRows += '|-----------|--------|\n';
                for (const bench of benches) {
                  fileRows += `| ${bench.name} | ${fmtOps(bench.opsPerSec)} |\n`;
                  fileNew++;
                }
              }

              totalImproved += fileImproved;
              totalRegressed += fileRegressed;
              totalNew += fileNew;
              totalUnchanged += fileUnchanged;

              const parts = [];
              if (fileImproved > 0) parts.push(`ðŸŸ¢ ${fileImproved} improved`);
              if (fileRegressed > 0) parts.push(`ðŸ”´ ${fileRegressed} regressed`);
              if (fileNew > 0) parts.push(`ðŸ†• ${fileNew} new`);
              if (fileUnchanged > 0) parts.push(`${fileUnchanged} unchanged`);
              const fileSummary = (parts.length > 0 ? parts.join(', ') : `${benches.length} benchmarks`) + fmtAvg(fileChanges);

              fileBlocks.push({ fileName, fileSummary, fileRows, hasSignificant: fileImproved > 0 || fileRegressed > 0 });
            }

            // Overall summary
            const summaryParts = [];
            summaryParts.push(`**${totalBenchmarks}** benchmarks`);
            if (totalImproved > 0) summaryParts.push(`ðŸŸ¢ ${totalImproved} improved`);
            if (totalRegressed > 0) summaryParts.push(`ðŸ”´ ${totalRegressed} regressed`);
            if (totalNew > 0) summaryParts.push(`ðŸ†• ${totalNew} new`);
            if (totalUnchanged > 0) summaryParts.push(`${totalUnchanged} unchanged`);
            body += summaryParts.join(' Â· ') + fmtAvg(allChanges) + '\n\n';

            // File sections as collapsible details
            for (const block of fileBlocks) {
              const shortName = block.fileName.replace(/^benchmarks\//, '');
              const open = block.hasSignificant ? ' open' : '';
              body += `<details${open}>\n`;
              body += `<summary><strong>${shortName}</strong> â€” ${block.fileSummary}</summary>\n\n`;
              body += block.fileRows;
              body += `\n</details>\n\n`;
            }

            body += `<sub>Measured on ubuntu-latest x64. Changes within Â±${THRESHOLD}% are considered insignificant.</sub>`;

            const marker = '<!-- benchmark-comparison -->';
            body = marker + '\n' + body;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body && c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
